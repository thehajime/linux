# SPDX-License-Identifier: GPL-2.0
#
# Copyright (C) 2000 - 2007 Jeff Dike (jdike@{addtoit,linux.intel}.com)
#

# Don't instrument UML-specific code
KCOV_INSTRUMENT                := n

include $(objtree)/include/config/auto.conf

liblinux-y += execvp.o file.o helper.o irq.o mem.o process.o \
	registers.o sigio.o signal.o time.o tty.o \
	umid.o util.o drivers/

CFLAGS_signal.o += -Wframe-larger-than=4096

ifndef CONFIG_UMMODE_LIB
liblinux-y += main.o start_up.o skas/
HEADER_ARCH 	:= x86
liblinux-y += x86/
else
HEADER_ARCH 	:= um/lkl
liblinux-y += lkl/
endif

liblinux-$(CONFIG_ARCH_REUSE_HOST_VSYSCALL_AREA) += elf_aux.o

export O = $(srctree)
objtree := $(O)
# reset CFLAGS
CFLAGS := -g -O2

# from arch/um/Makefile
ARCH_DIR := arch/um
HOST_DIR := arch/$(HEADER_ARCH)
ifdef CONFIG_64BIT
  KBUILD_CFLAGS += -mcmodel=large
endif

# from scripts/Kbuild.include
try-run = $(shell set -e;		\
	TMP="$(TMPOUT).$$$$.tmp";	\
	TMPO="$(TMPOUT).$$$$.o";	\
	if ($(1)) >/dev/null 2>&1;	\
	then echo "$(2)";		\
	else echo "$(3)";		\
	fi;				\
	rm -f "$$TMP" "$$TMPO")

__cc-option = $(call try-run,\
        $(1) -Werror $(2) $(3) -c -x c /dev/null -o "$$TMP",$(3),$(4))
CC_OPTION_CFLAGS := $(filter-out $(GCC_PLUGINS_CFLAGS),$(KBUILD_CFLAGS))
cc-option = $(call __cc-option, $(CC),\
        $(KBUILD_CPPFLAGS) $(CC_OPTION_CFLAGS),$(1),$(2))


include $(srctree)/$(HOST_DIR)/Makefile.um

KBUILD_CFLAGS += $(CFLAGS) $(CFLAGS-y) -D__arch_um__ \
	$(ARCH_INCLUDE) $(MODE_INCLUDE) -Dvmap=kernel_vmap	\
	-Dlongjmp=kernel_longjmp -Dsetjmp=kernel_setjmp \
	-Din6addr_loopback=kernel_in6addr_loopback \
	-Din6addr_any=kernel_in6addr_any -Dstrrchr=kernel_strrchr
KBUILD_CFLAGS := $(filter-out -Dsigprocmask=kernel_sigprocmask,$(KBUILD_CFLAGS))
SHARED_HEADERS	:= $(ARCH_DIR)/include/shared
MODE_INCLUDE	+= -I$(srctree)/$(ARCH_DIR)/include/shared/skas
ARCH_INCLUDE	:= -I$(srctree)/$(SHARED_HEADERS)
ARCH_INCLUDE	+= -I$(srctree)/$(HOST_DIR)/um/shared
KBUILD_CPPFLAGS += -I$(srctree)/$(HOST_DIR)/um
USER_CFLAGS := $(patsubst $(KERNEL_DEFINES),,$(patsubst -I%,,$(KBUILD_CFLAGS))) \
		$(ARCH_INCLUDE) $(MODE_INCLUDE) $(filter -I%,$(CFLAGS)) \
		-D_FILE_OFFSET_BITS=64 -idirafter $(srctree)/include/uapi \
		-idirafter $(objtree)/include -D__KERNEL__ -D__UM_HOST__

# from Makefile-os-Linux
USER_CFLAGS += -D_GNU_SOURCE -D_LARGEFILE64_SOURCE

# from Makefile.rules
CFLAGS += $(USER_CFLAGS) -include $(srctree)/tools/include/linux/kern_levels.h -include user.h $(CFLAGS_$(basetarget).o)
